#!/bin/bash
echo "This Docker container is a good Ubuntu build environment, both for x86 and ARM64 (aarch64)"
set -x
export CONTAINER=ubuntu-build-container
# make user that user is in the docker group
grep -q '^docker:.*user' /etc/group || sudo usermod -aG docker user
if [ "$(id -gn)" != "docker" ]
then
    # re-exec the shell script so we are running in the docker group
    exec sg docker "$0 $*"
fi
echo "To mount the home directory, we will temporarily disable SELinux"
sudo setenforce 0
# docker build -t $CONTAINER .
docker run --mount type=bind,source=/home/user,target=/home/user -it --cap-add=SYS_PTRACE --security-opt seccomp=unconfined -u "1000:1000" --init --platform linux/arm64 --name $CONTAINER $CONTAINER /bin/bash
/bin/rm -f $CONTAINER.tar
set -x
docker ps -a
set +x
echo " "
echo " "
set -x
docker container ls -a
set +x
echo " "
echo " "
set -x
docker save $CONTAINER -o $CONTAINER.tar
set +x
echo " "
echo " "
set -x
docker container ls -a
set +x
echo "Note the container was run without --rm, you may want to: docker rm $CONTAINER"
echo "Done."
exit 0
